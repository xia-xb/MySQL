# 进阶15存储过程和函数

存储过程和函数：类似于方法

好处：

- 提高代码的重用性
- 简化操作

# 存储过程

含义：一组预先编译好的sql语句的集合，理解成批处理语句

- 提高代码的重用性
- 简化操作
- 简化了编译次数并且减少了和数据库服务器的连接次数，提高了效率

## 存储过程的创建

1. 调用

1. 创建语法

```sql
#
create procedure 存储过程名(参数列表)
begin
	存储过程体（一组合法的sql语句）
end
```

==注意：==

- 参数列表包含三部分（参数模式  参数名  参数类型）（举例 in stuname varchar(20)）

  参数模式：

  - in: 该参数可以作为输入，也就是该参数需要调用方传入值
  - out:  该参数可以作为输出，也就是该参数可以作为返回值
  - inout: 该参数既可以作为输入也可以作为输出，也就是该参数既需要传入值，也可以返回值

- 如果存储过程体仅仅只有一句话，begin end可以省略

- 存储过程体中的每条sql语句的结尾要求必须加分号

- 存储过程的结尾可以使用delimiter重新设置

  语法：

  delimiter 结束标记

  例如delimiter $

1. 调用语法

   ```sql
   call 存储过程名(实参列表);
   ```

   

```sql

#空参列表
#插入到admin表中五条记录
delimiter $
create procedure myp1()
begin 
	insert into admin(username,password)
    values('john1','0000'),('lily','0000'),('rose','0000'),('jace','0000'),('tom','0000');
end $

call myp1();

#带in模式参数的存储过程
#创建存储过程实现根据女神名，查询对应的男神信息
create procedure myp2(in beautyname varchar(20))
begin
	select bo.*
	from boys bo
	right join beauty b on bo.id=b.boyfriend_id
	where b.name=beautyname;
end $

call myp2('柳岩')$;
#创建存储过程实现，用户是否登录成功
create procedure myp3(in username varchar(20),in password vacchar(20))
begin
	declare result varchar(20) default '';
	select count(*) into result
	from admin
	where admin.username=username
	and admin.password=passsword;
	
	select result;
end $

call myp3('张飞','8888');

create procedure myp4(in username varchar(20),in password vacchar(20))
begin
	declare result int default 0; #声明并初始化
	select count(*) into result   #赋值
	from admin
	where admin.username=username
	and admin.password=passsword;
	
	select if(result>0,'成功','失败');  #使用
end $

call myp4('张飞','8888');

#带out模式的存储过程
#根据女神名，返回对应的男神名
create procedure myp5(in beautyname varchar(20),out boyname varchar(20))
begin
	select bo.boyname into boyname
	from boysname as bo
	inner join beauty as b on bo.id=b.boyfriend_id
	where b.name=beautyname;
end $

set @bname$;
call myp5('小昭',@bname)$
select @bname$

#根据女神名，返回对应的男神名和男神魅力值
create procedure myp6(in beautyname varchar(20),out boyname varchar(20),out userCP int)
begin
	select bo.boyname,bo.userCP into boyname,userCP
	from boysname as bo
	inner join beauty as b on bo.id=b.boyfriend_id
	where b.name=beautyname;
end $

call myp6('小昭',@bname,@username)$


#带inout模式参数的存储过程
#传入a和b两个值，最终a和b都翻倍并返回
create procedure myp8(inout a int,inout b int)
begin
	set a=a*2;
	set b=b*2;
end $

set @m=10$;
set @n=20$;
call myp8(@m,@n)$;
select @m,@n;
```

## 存储过程的删除

语法

```sql
drop procedure 存储过程名;

drop procedure p1;
```

## 查看存储过程的信息

```sql
show create procedure 存储过程名;

show create procedure myp2;
```

# 函数

含义：一组预先编译好的sql语句的集合，理解成批处理语句

- 提高代码的重用性
- 简化操作
- 简化了编译次数并且减少了和数据库服务器的连接次数，提高了效率

区别

存储过程：可以有0个返回，也可以有多个返回，适合批量插入、批量更新

函数：有且仅有1个返回，适合做处理数据后返回一个结果

## 函数的创建

语法

```sql
create function 函数名(参数列表) returns 返回类型
begin
 	函数体
end
```



==注意：==

- 参数列表包含两部分：参数名，参数类型

- 函数体：肯定会有return语句，如果没有会报错，如果return语句没有放在函数体的最后也不报错，但不建议

  return 值;

- 函数体中只有一句话，则可以省略begin end

- 使用delimiter语句设置结束标记

## 调用

```sql
select 函数名（参数列表）
```

```sql
#无参有返回
create function myf1() returns int
begin
	declare c int default 0;
	select count(*) into c
	from employees;
	return c;
end $

select myf1()$

#有参有返回
#根据员工名返回他的工资
create function myf2(empname varchar(20)) returns double
begin
	set @sal=0;#定义用户变量
	select salary into @sal #赋值
	from employees
	where last_name=empname;
	return @sal;
end $

select myf2('k_ing') $

#根据部门名，返回该部门的平均工资
create function myf3(depname varchar(20))returns double
begin
	declare sal double;
	select avg(salary) into sal
	from employees as e
	joinn departments as d on e.department_id=d.department_id
	where d.department_name=departname;
	return sal;
end

select myf2('IT')$
```

## 查看

```sql
show create function myf3;
```

## 删除函数

```sql
drop function myf3;
```

```sql
#
create function test_fun1(num1 float ,num2 float) returns float
begin
	declart sum float default 0;
	select sum=num1+num2;
	return sum;
end $

select test_fun1(1,2)$
```

